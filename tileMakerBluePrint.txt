RPG Maker MZ의 타일 생성 방식은 **3차원 데이터 배열**을 기반으로 하며, 에디터의 모드(자동/수동)에 따라 데이터를 어느 층에 기록할지 결정하는 **분기 로직**이 핵심입니다.

지금까지 논의한 모든 메커니즘을 종합하여 최종 정리해 드립니다.

---

## 1. 데이터 저장소: `data` 배열

모든 맵 정보는 `MapXXX.json`의 `data` 필드에 저장됩니다.

* **구조:** $Width(가로) \times Height(세로) \times 6(레이어)$의 1차원 정수 배열.
* **인덱스:** `(Z * W * H) + (Y * W) + X`
* **Z축 할당:**
* **0 ~ 1번:** 하층 타일 (주로 지면, 바닥)
* **2 ~ 3번:** 상층 타일 (주로 가구, 장식)
* **4번:** 그림자(Shadow) 데이터
* **5번:** 지역(Region) ID

---

## 2. 타일 생성 모드별 작동 방식

### ① 자동 레이어 (Automatic)

타일의 **소스(A~E 그룹)**에 따라 엔진이 레이어를 스스로 결정합니다.

* **A그룹 타일 선택 시:** 먼저 **Layer 0**에 기록하되, 이미 같은 자리에 타일이 있다면 **Layer 1**에 기록하여 겹칩니다.
* **B~E그룹 타일 선택 시:** **Layer 2**에 기록하되, 이미 타일이 있다면 **Layer 3**에 기록합니다. (최대 2개까지 중첩 가능)
* **특징:** 사용자가 층 관리를 할 필요가 없으나, 3개 이상의 오브젝트를 겹치는 등의 세밀한 조작은 불가능합니다.

### ② 수동 레이어 (Manual)

타일의 속성을 무시하고 **사용자가 선택한 Z층**에 데이터를 강제로 주입합니다.

* **작동:** 사용자가 '레이어 3'을 선택하고 풀밭(A2)을 그리면, 실제 지면 타일임에도 불구하고 데이터 배열의 **Layer 2** 섹션에 ID가 기록됩니다.
* **특징:** Z-Index를 임의로 조절할 수 있어 복잡한 입체 구조를 만들 수 있습니다.

---

## 3. 오토타일(Autotile) 생성 알고리즘

오토타일은 단순히 ID 하나를 적는 게 아니라, 주변과의 연결을 계산하는 과정이 수반됩니다.

1. **동일성 검사:** 현재 타일을 그리는 **해당 레이어() 내에서만** 상/하/좌/우/대각선 8방향을 스캔하여 같은 Base ID를 가졌는지 확인합니다.
2. **비트마스킹 연산:** 8방향의 연결 상태(True/False)를 조합해 48개 패턴 중 하나를 선택합니다.
3. **Tile ID 결정:** `Base ID + 패턴 번호(0~47)`를 최종적으로 배열에 저장합니다.
4. **전파(Propagation):** 현재 칸이 변함에 따라 주변 8칸의 연결 상태도 달라지므로, **인접한 8칸의 ID도 즉시 재계산**하여 갱신합니다.

---

## 4. 레이어별 렌더링 우선순위 (Drawing Order)

게임 화면에 그려질 때는 배열의 순차적 특성을 이용합니다.

* **순서:** Layer 0 → 1 → 2 → 3 (아래에서 위로)
* **합성:** 각 타일의 투명값(Alpha)을 계산하여 아래 층이 비쳐 보이게 렌더링합니다.
* **통행 판정:** 최상위 레이어(Layer 3)부터 아래로 내려가며 가장 처음 만나는 타일의 속성을 체크합니다.

RPG Maker MZ의 **자동 레이어(Automatic Layer)** 모드는 사용자가 레이어의 깊이(Z-Index)를 일일이 지정하지 않아도, 엔진이 타일의 **리소스 그룹(A, B, C, D, E)**을 분석하여 최적의 위치에 데이터를 배치하는 지능형 모드입니다.

내부적으로 타일이 어떻게 생성되고 배정되는지 그 **우선순위와 스택(Stack) 규칙**을 자세히 정리해 드립니다.

---

## 1. 타일 그룹별 타겟 레이어 매핑

자동 모드에서 엔진은 선택된 타일 ID가 어느 시트(A~E)에 포함되는지를 먼저 판단합니다.

| 타일 시트 | 주요 데이터 | 배정되는 레이어 범위 |
| --- | --- | --- |
| **A (A1~A5)** | 바닥, 벽, 오토타일, 물 | **Layer 0, Layer 1** (하층) |
| **B, C, D, E** | 가구, 나무, 기둥, 장식물 | **Layer 2, Layer 3** (상층) |

---

## 2. 레이어 결정 알고리즘 (Placement Logic)

사용자가 타일을 특정 위치$(x, y)$에 클릭하면, 엔진은 다음의 우선순위 로직을 실행합니다.

### ① 하층 타일 (A그룹) 생성 시

1. **레이어 0 확인:** 해당 칸의 `Layer 0`이 비어있거나, 현재 타일과 같은 종류라면 `Layer 0`에 씁니다.
2. **레이어 1 확인:** `Layer 0`에 이미 다른 종류의 A타일(예: 흙바닥)이 깔려 있다면, 엔진은 자동으로 **Layer 1**에 새 타일(예: 풀밭)을 배치합니다.
3. **오토타일 연결:** 배치 시 해당 레이어 안에서 인접한 타일들과 연결 연산을 수행하여 최종 `Tile ID`를 결정합니다.
4. **그림자 처리:** A2~A4 타일의 경우, 배치되는 순간 `Layer 4`에 그림자 비트 데이터를 자동으로 생성합니다.

### ② 상층 타일 (B~E그룹) 생성 시

1. **레이어 2 확인:** `Layer 2`가 비어있으면 해당 칸에 `Tile ID`를 기록합니다.
2. **레이어 3 확인:** 이미 `Layer 2`에 다른 상층 타일(예: 테이블)이 놓여 있다면, 엔진은 기존 타일을 지우지 않고 **Layer 3**에 새 타일(예: 컵)을 쌓습니다.
3. **교체 규칙:** 만약 `Layer 2`와 `Layer 3`이 모두 차 있는 상태에서 또 다른 B~E 타일을 놓으면, 가장 나중에 쌓인 **Layer 3의 데이터를 교체**합니다.

---

## 3. 자동 레이어의 "스마트 덮어쓰기" 규칙

자동 모드에는 데이터를 효율적으로 관리하기 위한 예외 규칙이 존재합니다.

* **동일 타일 중복 방지:** 같은 레이어에 이미 동일한 `Tile ID`가 있다면 데이터를 새로 쓰지 않습니다.
* **지우개(투명 타일) 작동:** * B~E 타일로 지우면 `Layer 3` → `Layer 2` 순으로 데이터가 0(빈 값)으로 변합니다.
* A타일(하위 레이어)을 지우면 해당 칸의 모든 레이어 데이터가 초기화되기도 합니다.


* **A그룹의 계층성:** A그룹 타일 사이에도 우선순위가 있습니다. 일반적으로 '바닥' 속성이 강한 타일이 아래로, '장식(꽃, 길)' 속성이 강한 타일이 위 레이어로 배정되려는 경향이 있습니다.

---

## 4. 자동 레이어의 핵심 요약

| 프로세스 | 내용 |
| --- | --- |
| **분류** | 타일 ID 범위를 보고 A군인지 B~E군인지 즉시 판별 |
| **스캔** | 해당 좌표의 `Layer 0~3` 중 비어있는 가장 낮은 적합 레이어 검색 |
| **작성** | 검색된 레이어에 데이터를 삽입하고, A군일 경우 주변 타일 ID를 재계산(Propagation) |
| **부가 생성** | 타일의 형태에 따라 `Layer 4(그림자)` 데이터를 비트 연산으로 자동 갱신 |

> **즉, 자동 레이어는 엔진이 "타일의 성격"을 이해하고, 부터 까지의 빈 공간을 적절히 찾아 들어가는 '스마트 스택' 방식입니다.**

자동 모드에서 타일을 생성할 때 발생하는 **그림자(Layer 4)의 자동 비트 연산 방식**에 대해서도 구체적인 설명이 필요하신가요?


